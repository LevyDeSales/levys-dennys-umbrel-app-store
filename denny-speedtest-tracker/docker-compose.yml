services:
  app_proxy:
    environment:
      APP_HOST: denny-speedtest-tracker_app_1
      APP_PORT: 80

  app:
    image: ghcr.io/linuxserver/speedtest-tracker:1.6.6@sha256:de6a0fa6e0c8800886922dd742ed5b99c91f1814009dab10d08ead8623515b75
    restart: on-failure
    healthcheck:
      test: curl -f http://localhost:80/ || exit 1
    environment:
      PUID: 1000
      PGID: 1000
      APP_TIMEZONE: Europe/Berlin
      DISPLAY_TIMEZONE: Europe/Berlin
      APP_KEY: base64:Mk3oIhBicQx5NuTYpKcqNSRt4ANv+3nikg+z9yzWYrI=
      DB_CONNECTION: pgsql
      DB_HOST: db
      DB_DATABASE: speedtest
      DB_USERNAME: speedtestuser
      DB_PASSWORD: speedtestpass
    volumes:
      - ${APP_DATA_DIR}/data/config:/config:rw

  db:
    image: postgres:17.5@sha256:aadf2c0696f5ef357aa7a68da995137f0cf17bad0bf6e1f17de06ae5c769b302
    restart: on-failure
    hostname: db
    mem_limit: 1g
    cpu_shares: 1024
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "pg_isready", "-q", "-d", "speedtest", "-U", "speedtestuser"]
      timeout: 45s
      interval: 10s
      retries: 10
    volumes:
      - ${APP_DATA_DIR}/data/db:/var/lib/postgresql/data:rw
    environment:
      POSTGRES_DB: speedtest
      POSTGRES_USER: speedtestuser
      POSTGRES_PASSWORD: speedtestpass
